apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: logs
  namespace: observability
spec:
  mode: deployment
  replicas: 1

  image: otel/opentelemetry-collector-contrib:0.143.0

  config:
    receivers:
      # Alloy â†’ OTel ä½¿ç”¨ OTLP
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      # Kubernetes å…ƒä¿¡æ¯è¡¥å…¨ï¼ˆéå¸¸å…³é”®ï¼‰
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.node.name
            - k8s.container.name
            - k8s.pod.uid
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection

      # ç»Ÿä¸€èµ„æºå±æ€§ï¼ˆenv / cluster / serviceï¼‰
      resource:
        attributes:
          - key: cluster
            value: prod-cluster
            action: upsert
          - key: telemetry.sdk
            value: alloy
            action: upsert

      # æ‰¹å¤„ç†ï¼ˆç”Ÿäº§å¿…é¡»ï¼‰
      batch:
        send_batch_size: 1024
        timeout: 5s

    exporters:
      # ğŸ‘‰ æ–¹æ¡ˆä¸€ï¼šå‘ç»™ Lokiï¼ˆæ¨èä½ ç°åœ¨ç”¨ï¼‰
      loki:
        endpoint: http://loki-distributor.monitoring.svc.cluster.local:3100/loki/api/v1/push
        labels:
          attributes:
            k8s.namespace.name: namespace
            k8s.pod.name: pod
            k8s.container.name: container
            k8s.node.name: node
            cluster: cluster
            service.name: service

      # ğŸ‘‰ æ–¹æ¡ˆäºŒï¼šå‘ç»™ Elasticsearchï¼ˆå¯é€‰ï¼‰
      # elasticsearch:
      #   endpoints: ["http://elasticsearch.monitoring.svc:9200"]
      #   logs_index: otel-logs-%{+yyyy.MM.dd}

    service:
      pipelines:
        logs:
          receivers: [otlp]
          processors: [k8sattributes, resource, batch]
          exporters: [loki]