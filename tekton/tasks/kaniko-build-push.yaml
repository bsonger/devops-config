apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build-push
spec:
  description: ä½¿ç”¨ Kaniko æ„å»ºå¹¶æ¨é€é•œåƒåˆ° Harborï¼ˆä½¿ç”¨ harbor-auth secretï¼‰
  params:
    - name: image
      description: ç›®æ ‡é•œåƒï¼ˆä¾‹å¦‚ harbor.example.com/project/image:tagï¼‰
      type: string
    - name: DOCKERFILE
      description: Dockerfile æ–‡ä»¶åï¼ˆé»˜è®¤ï¼šDockerfileï¼‰
      type: string
      default: Dockerfile
    - name: CONTEXT
      description: Build context è·¯å¾„ï¼ˆé»˜è®¤ï¼š.ï¼‰
      type: string
      default: .
  workspaces:
    - name: source
      description: æºä»£ç ç›®å½•ï¼ˆåŒ…å« Dockerfileï¼‰
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.22.0
      env:
        - name: DOCKER_CONFIG
          value: /kaniko/.docker/
      script: |
        #!/busybox/sh
        echo "ğŸš€ ä½¿ç”¨ Kaniko æ„å»ºé•œåƒï¼š$(params.IMAGE)"
        /kaniko/executor \
          --dockerfile=$(workspaces.source.path)/$(params.DOCKERFILE) \
          --context=$(workspaces.source.path)/$(params.CONTEXT) \
          --destination=$(params.IMAGE) \
          --snapshotMode=time \
          --verbosity=info
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker/
  volumes:
    - name: docker-config
      secret:
        secretName: harbor-auth
        items:
          - key: .dockerconfigjson
            path: config.json
