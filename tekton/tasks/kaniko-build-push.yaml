apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build-push
  namespace: tekton-pipelines
spec:
  description: ä½¿ç”¨ Kaniko æ„å»ºå¹¶æ¨é€é•œåƒåˆ° Harborï¼ˆä½¿ç”¨ harbor-auth secretï¼‰
  params:
    - name: IMAGE
      description: ç›®æ ‡é•œåƒï¼ˆä¾‹å¦‚ harbor.example.com/project/image:tagï¼‰
      type: string
    - name: DOCKERFILE
      description: Dockerfile æ–‡ä»¶åï¼ˆé»˜è®¤ï¼šDockerfileï¼‰
      type: string
      default: Dockerfile
    - name: CONTEXT
      description: Build context è·¯å¾„ï¼ˆé»˜è®¤ï¼š.ï¼‰
      type: string
      default: .
  workspaces:
    - name: source
      description: æºä»£ç ç›®å½•ï¼ˆåŒ…å« Dockerfileï¼‰
    - name: dockerconfig
      description: Harbor ç™»å½• Secretï¼ˆåº”ä¸ºåŒ…å« config.json çš„ Secretï¼‰
      mountPath: /kaniko/.docker/   # âœ… è®© Tekton è‡ªåŠ¨æŒ‚è½½è¿™ä¸ª workspace åˆ°è¯¥è·¯å¾„
  steps:
    - name: check-docker-config
      image: alpine
      imagePullPolicy: IfNotPresent
      script: |
        echo "ğŸ” /kaniko/.docker ç›®å½•å†…å®¹:"
        ls -al /kaniko/.docker
        echo "ğŸ“„ config.json å†…å®¹:"
        cat /kaniko/.docker/config.json || echo "âŒ config.json ä¸å­˜åœ¨"
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.22.0
      imagePullPolicy: IfNotPresent
      env:
        - name: DOCKER_CONFIG
          value: /kaniko/.docker/
        - name: HTTP_PROXY
          value: http://192.168.1.5:7890
        - name: HTTPS_PROXY
          value: http://192.168.1.5:7890
        - name: NO_PROXY
          value: localhost,127.0.0.1,.svc,.cluster.local
      command:
        - /kaniko/executor
      args:
        - --dockerfile=$(workspaces.source.path)/$(params.DOCKERFILE)
        - --context=$(workspaces.source.path)/$(params.CONTEXT)
        - --destination=$(params.IMAGE)
        - --snapshot-mode=time
        - --verbosity=info
